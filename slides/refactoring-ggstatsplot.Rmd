---
title: "Lessons learned while refactoring {ggstatsplot}"
subtitle: "Going from 10K to 1.5K lines of code"
author: "Indrajeet Patil"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    #self_contained: true
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  dpi = 300,
  out.width = "100%"
)

options(htmltools.dir.version = FALSE)
```

```{r xaringanExtra-search, echo=FALSE}
xaringanExtra::use_search(show_icon = TRUE)
```

```{css, echo=FALSE}
.remark-code {
  font-size: 0.7em;
}

.remark-code, .remark-inline-code {
  font-family: 'JetBrainsMono-Regular';
}
```


# Note Before

I put together these slides in a hurry<sup>*</sup>, because (unexpectedly to me) a number of people were curious about this refactoring.

.footnote[<sup>*</sup>I'm on holiday until 31st of August and don't have time to polish these slides further. ðŸ˜¿]

<blockquote class="twitter-tweet" data-theme="dark"><p lang="en" dir="ltr">{ggstatsplot}&#39;s codebase was &gt; 10,000 lines of code 2 yrs ago. Since then, I&#39;ve slowly, painfully, and painstakingly refactored it without compromising on functionality.<br><br>And now it&#39;s only ~ 1,600 lines of code!<br><br>Refactoring code is a strangely rewarding (and additive) process ðŸ™ƒ</p>&mdash; Indrajeet Patil (@patilindrajeets) <a href="https://twitter.com/patilindrajeets/status/1421844249277091842?ref_src=twsrc%5Etfw">August 1, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

---

class: inverse, center, middle

# Prologue

---

### What does `{ggstatsplot}` do?

You don't need to know much about `{ggstatsplot}` to follow these slides, except that it produces `ggplot2` plots with statistical analysis embedded in the plot. For more, see these [slides](https://indrajeetpatil.github.io/ggstatsplot_slides/slides/ggstatsplot_presentation.html#1). Here is an example plot:

```{r, echo=FALSE, out.width="60%", fig.width=8}
library(ggstatsplot)
library(palmerpenguins)

ggbetweenstats(penguins, species, flipper_length_mm,
  xlab = "Penguin species", ylab = "Flipper length (in mm)",
  title = "Flipper bill length by species"
)
```

---

### State of codebase in 2019

<blockquote class="twitter-tweet" data-theme="dark"><p lang="en" dir="ltr">What is the state of the ggplot2 package ecosystem?<br><br>There are 120k lines of R code (!) across ggplot2 and its 40+ extensions at <a href="https://t.co/DJCdhDTJo0">https://t.co/DJCdhDTJo0</a><br><br>ggstatsplot &amp; ggplot2 make up 1/3 of the total.<br><br>My package, ggdark, is the 4th smallest. ðŸ™‚<a href="https://twitter.com/hashtag/tidytuesday?src=hash&amp;ref_src=twsrc%5Etfw">#tidytuesday</a> <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://t.co/FVbg8vROte">pic.twitter.com/FVbg8vROte</a></p>&mdash; Neal Grantham ðŸ†– (@nsgrantham) <a href="https://twitter.com/nsgrantham/status/1194676877425725440?ref_src=twsrc%5Etfw">November 13, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

---

### "What's the problem with that?!"

- Hard to maintain a large codebase
- Adding new features becomes difficult

> *The goal of software architecture is to minimize the human resources required to build and maintain the required system.*
Robert C. Martin (*Clean Architecture*, p.5)

### "What does refactoring get you?"

- Forces you to think about design patterns in your code
- Improves the code you will write in the future

---

class: inverse, center, middle

# Preconditions

---

# Three things to do before refactoring

--
1. 100 % code coverage<br>
--
2. 100 % code coverage<br>
--
3. 100 % code coverage<br>
--
<br>
Try your absolute best to *break* your own code and add tests for every instance

---

class: inverse, center, middle

# Ruthlessly DRY

---

### DRYing `{ggstatsplot}`

DRY or Don't repeat yourself [principle](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself) dictates reducing repetition of software patterns and replacing it with abstractions to avoid redundancy.

During refactoring:

- Code that was repeated even twice was abstracted into its own helper function.

---

class: inverse, center, middle

# Divide and conquer

---

### Don't reinvent wheel

- Resist temptation to duplicate efforts by writing functions for doing things that other packages already do, unless, of course, the whole point of the package is to (e.g.) provide a more performant alterantive. Yes, you should be cautious about number of dependencies, but that's not the *only* thing you should worry about. I'd highly recommend [this talk](https://www.youtube.com/watch?v=mum13N7CGUI&ab_channel=RStudio) by Jim Hester to better understand this trade-off.

- Instead choose a dependency and use its functionality. If it is missing features you desire, instead of adding them in your own software, contribute to the dependency itself.
 
- For example, `{ggstatsplot}` used to have custom functions to compute confidence intervals for effect sizes but all of these were removed in favor an [excellent package](https://easystats.github.io/effectsize/) dedicated to computing effect sizes and their confidence intervals.

- At this point, I am either co-author or contributor on a number of `ggstatsplot`'s hard dependencies.

---

class: inverse, center, middle

# Functional programming

---

R is a [functional language](https://adv-r.hadley.nz/fp.html) and you can take advantage of that.

For example, while writing functions, you can assign functions to variables. Note also that this gets rid of repeated function arguments specification. 

.pull-left[
```{r, eval=FALSE}
# before: 14 lines of code
foo <- function(a, b, type, ...) {
  if (type == "p") {
    return(stats::t.test(
      x = a,
      y = b,
      ...
    ))
  }

  if (type == "np") {
    return(stats::wilcox.test(
      x = a,
      y = b,
      ...
    ))
  }
}
```
]

.pull-right[
```{r, eval=FALSE}
# after: 8 lines of code
foo <- function(a, b, type, ...) {
  if (type == "p") .f <- stats::t.test
  if (type == "np") .f <- stats::wilcox.test

  return(rlang::exec(
    .f,
    x = a,
    y = b,
    ...
  ))
}
```

]

---

class: inverse, center, middle

# Getting carried away

The following might be considered **bad coding practices** by some practitioners because they reduce readability of the code, especially for contributors. But I'd still like to mention them for the sake of completeness.

---

### Modify-in-place with assignment pipe `%<>%`

See: <https://magrittr.tidyverse.org/reference/compound.html>

```{r, eval=FALSE}
# before: 2 lines of code
df <- df %>%
  mutate(c = a + b)

# after: a single like of code
df %<>% mutate(c = a + b)
```

---

### Multiple assignment using `%<-%`

See: <https://rdrr.io/cran/zeallot/man/operator.html>

```{r, eval=FALSE}
# before: 3 lines of code
x <- 1
y <- "b"
z <- TRUE

# after: 1 line of code
c(x, y, z) %<-% c(1, "b", TRUE)
```

---

class: inverse, center, middle

# Epilogue
Struggles that define you

---

### "Why didn't you use these methods when you started writing the package?"

- Started *learning* R in January 2017 and started working on `{ggstatsplot}` in Oct/Nov 2017, so did not have much experience with R itself.

- Trained in Physics and then worked as a researcher in Social Neuroscience and Social Psychology, which means no formal computer science or software development training. Needed to make these mistakes to learn these lessons the hard way.

---

class: inverse, center, middle

# Resources

---

# Tools

None of this would have been possible without the following excellent tools/services:

- `covr`: <https://covr.r-lib.org/>
- `codecov`: <https://about.codecov.io/>
- `lintr`: <https://github.com/jimhester/lintr/blob/master/README.md>
- `github-actions`: <https://github.com/r-lib/actions>
- `travis-ci`<sup>*</sup>: <https://travis-ci.com/>
- `appveyor`<sup>*</sup>: <https://www.appveyor.com/>

.footnote[<sup>*</sup>I don't use these anymore in favor of github-actions, but before github-actions arrived on the scene, these CI services were essential part of my workflow.]

---

# Videos

<iframe width="560" height="315" src="https://www.youtube.com/embed/7oyiPBjLAWY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

---

# Books

```{r, echo=FALSE}
knitr::include_graphics("images/books.jpeg")
```
